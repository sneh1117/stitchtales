{% extends 'base.html' %}
{% block title %}{{ post.title }} ‚Äî StitchTales{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <article class="card p-4 mb-4">
            {% if post.cover_image %}
            <img src="{{ post.cover_image.url }}" class="post-cover mb-4" alt="{{ post.title }}">
            {% endif %}
            <div class="d-flex gap-2 mb-3 flex-wrap">
                {% if post.category %}
                <a href="{{ post.category.get_absolute_url }}" class="badge-category text-decoration-none">{{ post.category.name }}</a>
                {% endif %}
                <span class="reading-time"><i class="fas fa-clock"></i> {{ post.reading_time }} min read</span>
                <span class="reading-time"><i class="fas fa-eye"></i> {{ post.view_count }} views</span>
            </div>
            <h1 style="color: var(--yarn-brown);">{{ post.title }}</h1>
            <div class="d-flex align-items-center gap-2 mb-4">
                <small class="text-muted">by <a href="{% url 'author_detail' post.author.username %}">{{ post.author.get_full_name|default:post.author.username }}</a> ¬∑ {{ post.created_at|date:"M d, Y" }}</small>
            </div>
            <div class="post-content" style="line-height: 1.9;">{{ post.content|linebreaks }}</div>
            <div class="mt-4 d-flex flex-wrap gap-2">
                {% for tag in post.tags.all %}
                <a href="{{ tag.get_absolute_url }}" class="badge-tag text-decoration-none">{{ tag.name }}</a>
                {% endfor %}
            </div>

            <!-- Like Button -->
            <div class="mt-4" id="like-section">
                {% if user.is_authenticated %}
                <div hx-post="{% url 'like_post' post.slug %}"
                     hx-target="#like-section"
                     hx-swap="innerHTML"
                     hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                    {% include 'partials/like_button.html' %}
                </div>
                {% else %}
                <a href="{% url 'login' %}" class="btn btn-outline-secondary">ü§ç Login to Like</a>
                {% endif %}
            </div>
        </article>

        <!-- Comments Section -->
        <div class="card p-4 mb-4">
            <h5 style="color: var(--yarn-brown);">üí¨ Comments ({{ comments.count }})</h5>
            
            {% for comment in comments %}
            <div class="border-bottom py-3">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <strong>{{ comment.author.get_full_name|default:comment.author.username }}</strong>
                    <small class="text-muted">{{ comment.created_at|date:"M d, Y" }}</small>
                </div>
                <p class="mb-0">{{ comment.content }}</p>
            </div>
            {% empty %}
            <p class="text-muted py-2">No comments yet. Be the first! üß∂</p>
            {% endfor %}

            <!-- Comment Form -->
            <div class="mt-4">
                {% if user.is_authenticated %}
                <h6>Leave a Comment</h6>
                <form method="POST" action="{% url 'post_detail' post.slug %}">
                    {% csrf_token %}
                    {{ comment_form.content }}
                    <button type="submit" class="btn btn-primary mt-2">Post Comment</button>
                </form>
                {% else %}
                <p><a href="{% url 'login' %}">Login</a> to leave a comment.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="sidebar-card text-center">
            {% if post.author.profile.avatar %}
            <img src="{{ post.author.profile.avatar.url }}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;" alt="">
            {% else %}
            <div class="mx-auto mb-2 bg-secondary text-white d-flex align-items-center justify-content-center" style="width:80px;height:80px;border-radius:50%;font-size:2rem;">{{ post.author.username|first|upper }}</div>
            {% endif %}
            <h6 class="mt-2">{{ post.author.get_full_name|default:post.author.username }}</h6>
            <p class="text-muted small">{{ post.author.profile.bio|default:"Crochet enthusiast" }}</p>
            <a href="{% url 'author_detail' post.author.username %}" class="btn btn-sm btn-primary">View Profile</a>
        </div>

        {% if related_posts %}
        <div class="sidebar-card">
            <h5 style="color: var(--yarn-brown);">üß∂ Related Posts</h5>
            {% for related in related_posts %}
            <a href="{{ related.get_absolute_url }}" class="d-block text-decoration-none text-dark border-bottom py-2">
                {{ related.title }}
                <small class="d-block text-muted">{{ related.reading_time }} min read</small>
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}